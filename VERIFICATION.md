# ================================
# CxyGPT 完整验收指南
# ================================

## 项目状态检查

✅ 前端依赖已安装 (377 packages)
✅ 网关依赖已安装 (FastAPI, Uvicorn)
✅ 所有组件文件已创建
✅ 配置文件已就位

---

## 🚀 快速验收（两步启动）

### 📌 准备工作

你需要：
- 2 个 PowerShell 终端窗口
- 浏览器（Chrome/Edge 推荐）

---

## ⚙️ Step 1: 启动 API 网关

### 打开 PowerShell 终端 #1

```powershell
# 进入项目根目录
cd H:\project\cxygpt

# 进入网关目录
cd apps\api-gateway

# 复制配置文件（注意：不要复制 PS 提示符！）
copy "..\..\\.env.single" .env

# 激活虚拟环境
.\venv\Scripts\Activate.ps1

# 启动网关
python -m api_gateway.main
```

### ✅ 预期输出

```
INFO:     Started server process [12345]
INFO:     Waiting for application startup.
{"timestamp":"2025-10-06T...","level":"INFO","logger":"__main__","message":"Starting CxyGPT API Gateway","extra":{"mode":"SINGLE_USER","profile":"SINGLE_32G",...}}
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8001 (Press CTRL+C to quit)
```

### 🔍 验证点 1：网关启动成功

- [ ] 看到 "Uvicorn running on http://0.0.0.0:8001"
- [ ] 没有报错信息
- [ ] 日志显示 "mode":"SINGLE_USER", "profile":"SINGLE_32G"

---

## 🌐 Step 2: 测试 Swagger 文档

### 打开浏览器

访问：**http://localhost:8001/docs**

### ✅ 预期界面

你应该看到：
- Swagger UI 文档页面
- 标题："CxyGPT API Gateway"
- 两个标签：
  - **System** (绿色)
  - **Chat** (蓝色)

### 🧪 测试 1: 健康检查

1. 展开 `GET /healthz`
2. 点击右侧 **"Try it out"** 按钮
3. 点击蓝色 **"Execute"** 按钮
4. 向下滚动查看响应

**✅ 预期响应**：
```json
{
  "ok": true
}
```

### 🧪 测试 2: 获取限额

1. 展开 `GET /v1/limits`
2. 点击 **"Try it out"**
3. 点击 **"Execute"**

**✅ 预期响应**：
```json
{
  "max_input_tokens": 3072,
  "max_output_tokens": 512,
  "rate_qps": 0,
  "rate_tpm": 0,
  "queue_size": 1,
  "single_user": true,
  "profile": "SINGLE_32G"
}
```

### 🧪 测试 3: 聊天接口（非流式）

1. 展开 `POST /v1/chat/completions`
2. 点击 **"Try it out"**
3. 在 **Request body** 框中，替换为以下内容：

```json
{
  "model": "qwen3-14b",
  "messages": [
    {
      "role": "user",
      "content": "你好"
    }
  ],
  "stream": false,
  "max_tokens": 50
}
```

4. 点击 **"Execute"**

**✅ 预期响应**：
```json
{
  "id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "object": "chat.completion",
  "created": 1728000000,
  "model": "qwen3-14b",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "你好！我是一个 AI 助手。"
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 10,
    "completion_tokens": 15,
    "total_tokens": 25
  }
}
```

### 🔍 验证点 2：API 正常工作

- [ ] 健康检查返回 `{"ok": true}`
- [ ] 限额接口返回正确配置
- [ ] 聊天接口返回 Mock 消息
- [ ] 没有 500 错误

**✅ 网关验收通过！**

---

## 💻 Step 3: 启动前端

### 打开 PowerShell 终端 #2（新窗口）

```powershell
# 进入项目根目录
cd H:\project\cxygpt

# 进入前端目录
cd apps\web

# 启动开发服务器
npm run dev
```

### ✅ 预期输出

```
  VITE v7.1.9  ready in 200 ms

  ➜  Local:   http://localhost:5173/
  ➜  Network: use --host to expose
  ➜  press h + enter to show help
```

**注意**：如果 5173 端口被占用，Vite 会自动使用其他端口（如 5174）

### 🔍 验证点 3：前端启动成功

- [ ] 看到 "VITE v7.1.9 ready"
- [ ] 显示 Local 地址
- [ ] 没有编译错误

---

## 🎨 Step 4: 前端界面验收

### 打开浏览器

访问：**http://localhost:5173**

（如果前端使用了其他端口，访问对应的端口）

---

### 📋 界面检查清单

#### ✅ 顶栏（TopBar）

- [ ] 左上角显示 "CxyGPT" （蓝紫渐变色）
- [ ] 品牌名旁边有一个**绿色圆点**（状态指示灯）
  - 绿色 = 网关正常
  - 灰色 = 检查中
  - 红色 = 网关异常
- [ ] 右上角有两个图标：
  - 月亮/太阳图标（主题切换）
  - 齿轮图标（设置）

#### ✅ 左侧栏（Sidebar）

- [ ] 顶部有蓝色 **"新对话"** 按钮（带加号图标）
- [ ] 下方有搜索框
- [ ] 显示至少一个自动创建的会话
  - 会话名称如："新对话 10/6 17:30"
  - 下方显示日期和 token 数
- [ ] 会话可以点击选中

#### ✅ 中央区域（ChatPane）

- [ ] 中间显示欢迎信息：
  - "💬 开始新对话"
  - "在下方输入您的问题"
- [ ] 底部有**输入框**
- [ ] 输入框右侧有蓝色**发送按钮**（纸飞机图标）
- [ ] 输入框下方显示：
  - **Token 计数**："0 / 3072 tokens"
  - **模式信息**："单人模式 · SINGLE_32G"

### 🔍 验证点 4：界面完整显示

- [ ] 页面**不是空白**
- [ ] 所有元素正确显示
- [ ] 状态灯是**绿色**（表示网关连接正常）
- [ ] 没有浏览器控制台错误

---

## 💬 Step 5: 对话功能测试

### 测试 1：发送简单消息

1. 在输入框中输入：**"你好"**
2. 按 **Enter** 键（或点击发送按钮）

#### ✅ 预期行为

- [ ] 用户消息立即出现在聊天区
  - 蓝色背景气泡
  - 右侧对齐
  - 显示 "你" 头像
  - 显示发送时间
- [ ] AI 消息开始**逐字显示**（打字效果）
  - 灰色背景气泡
  - 左侧对齐
  - 显示 "AI" 头像
  - 内容："你好！我是一个 AI 助手。"
- [ ] 消息完全显示后停止
- [ ] 鼠标悬停在消息上，右上角显示**复制按钮**

### 测试 2：停止功能

1. 在输入框输入：**"请用200字介绍人工智能"**
2. 点击发送
3. 在 AI 回复过程中，点击**红色停止按钮**（输入框右侧）

#### ✅ 预期行为

- [ ] AI 停止生成
- [ ] 已生成的内容保留
- [ ] 停止按钮变回发送按钮

### 测试 3：Markdown 渲染

1. 在输入框输入：**"生成一段包含代码的回复"**
2. 发送

#### ✅ 预期行为（Mock 模式下可能不明显）

- [ ] 消息支持 Markdown 格式
- [ ] 代码块有语法高亮
- [ ] 代码块右上角有复制按钮

### 🔍 验证点 5：对话功能正常

- [ ] SSE 流式渲染工作（逐字显示）
- [ ] 消息正确显示（用户/AI）
- [ ] 可以复制消息
- [ ] 停止按钮有效

---

## ⚙️ Step 6: 设置功能测试

### 打开设置抽屉

1. 点击顶栏右上角的**齿轮图标**

#### ✅ 预期界面

右侧滑出设置抽屉，包含：

**1. 当前档位信息（蓝色卡片）**
```
当前档位
模式：单人模式
档位：SINGLE_32G
输入限制：3072 tokens
输出限制：512 tokens
```

**2. 三个滑块**
- **Temperature**：0.00 - 2.00（默认 0.70）
- **Top P**：0.00 - 1.00（默认 0.90）
- **Max Tokens**：64 - 512（默认 512）

**3. 系统提示**
- 下拉框（模板选择）
- 文本框（自定义输入）

**4. 长文分析开关**
- 切换按钮（单人模式默认开启）

**5. 恢复默认设置按钮**

### 测试设置持久化

1. 将 **Temperature** 滑块调整到 **1.0**
2. 将 **Max Tokens** 调整到 **256**
3. 点击抽屉外侧关闭
4. 再次打开设置抽屉

#### ✅ 预期行为

- [ ] Temperature 仍为 1.0
- [ ] Max Tokens 仍为 256
- [ ] 设置已保存（使用 localStorage）

### 🔍 验证点 6：设置功能正常

- [ ] 设置抽屉正确打开/关闭
- [ ] 显示当前档位信息
- [ ] 滑块可以调整
- [ ] 设置会持久化保存

---

## 📁 Step 7: 会话管理测试

### 测试 1：创建新会话

1. 点击左侧 **"新对话"** 按钮

#### ✅ 预期行为

- [ ] 创建新会话
- [ ] 自动切换到新会话
- [ ] 聊天区清空
- [ ] 侧边栏显示两个会话

### 测试 2：切换会话

1. 点击侧边栏中的第一个会话

#### ✅ 预期行为

- [ ] 切换到该会话
- [ ] 聊天区显示该会话的历史消息

### 测试 3：会话操作

1. 鼠标**悬停**在任一会话上

#### ✅ 预期行为

- [ ] 右侧显示三个按钮：
  - 📌 固定/取消固定
  - ✏️ 重命名
  - 🗑️ 删除

2. 点击 **重命名** 按钮
3. 输入新名称："测试会话"
4. 按 Enter

#### ✅ 预期行为

- [ ] 会话名称更新为 "测试会话"
- [ ] 更改立即保存

### 🔍 验证点 7：会话管理正常

- [ ] 可以创建新会话
- [ ] 可以切换会话
- [ ] 可以重命名会话
- [ ] 会话数据持久化

---

## 🔄 Step 8: 模式切换测试（可选）

### 切换到多人模式

1. 在**网关终端**（终端 #1）按 **Ctrl+C** 停止网关

2. 执行以下命令：

```powershell
# 复制多人模式配置
copy "..\..\\.env.multi" .env

# 重新启动网关
python -m api_gateway.main
```

3. 在浏览器中**刷新前端页面**（F5）

#### ✅ 预期变化

查看输入框下方：

**之前（单人模式）**：
```
0 / 3072 tokens
单人模式 · SINGLE_32G
```

**之后（多人模式）**：
```
0 / 2048 tokens
多人模式 · DEV_32G
```

4. 打开**设置抽屉**

#### ✅ 预期变化

档位信息卡片显示：
```
当前档位
模式：多人模式
档位：DEV_32G
输入限制：2048 tokens
输出限制：256 tokens
QPS 限制：2
TPM 限制：4000
```

### 🔍 验证点 8：模式切换生效

- [ ] Token 限制动态变化
- [ ] 档位信息正确更新
- [ ] UI 上限自动调整

---

## 🐛 故障排查

### ❌ 问题 1：前端空白页面

**症状**：浏览器显示白屏

**排查步骤**：

1. 打开浏览器**开发者工具**（F12）
2. 查看 **Console** 标签
3. 检查是否有错误

**常见错误**：

**错误 A**：`Failed to fetch http://127.0.0.1:8001/v1/limits`
- **原因**：网关未启动
- **解决**：检查网关是否运行在 8001 端口

**错误 B**：`Module not found` 或导入错误
- **原因**：前端代码问题
- **解决**：在前端目录运行 `npm install`

**错误 C**：组件未定义
- **原因**：文件缺失
- **解决**：检查 `src/components/` 是否包含所有组件

---

### ❌ 问题 2：状态灯是灰色/红色

**症状**：顶栏状态灯不是绿色

**排查**：

1. **灰色** = 正在检查
   - 等待 10 秒
   - 如果一直灰色，检查网络连接

2. **红色** = 网关不可达
   - 确认网关是否运行：访问 http://localhost:8001/healthz
   - 检查防火墙设置
   - 检查前端环境变量 `VITE_API_GATEWAY_URL`

---

### ❌ 问题 3：发送消息无响应

**症状**：点击发送后没有反应

**排查步骤**：

1. 打开开发者工具 **Network** 标签
2. 发送消息
3. 查看是否有 `/v1/chat/completions` 请求

**情况 A**：没有请求
- **原因**：前端代码问题
- **解决**：检查浏览器 Console 错误

**情况 B**：请求失败（红色）
- **原因**：网关问题
- **解决**：查看网关终端日志

**情况 C**：请求成功但没显示
- **原因**：SSE 解析问题
- **解决**：检查浏览器 Console

---

### ❌ 问题 4：网关启动失败

**症状**：`python -m api_gateway.main` 报错

**常见错误**：

**错误 A**：`ModuleNotFoundError: No module named 'fastapi'`
- **解决**：
  ```powershell
  .\venv\Scripts\Activate.ps1
  pip install -r requirements.txt
  ```

**错误 B**：`Address already in use`
- **解决**：
  ```powershell
  # 杀掉占用 8001 端口的进程
  netstat -ano | findstr :8001
  taskkill /PID <进程ID> /F
  ```

**错误 C**：`FileNotFoundError: profiles.yaml`
- **解决**：确认 `configs/profiles.yaml` 文件存在

---

## ✅ 完整验收清单

### 网关（API Gateway）

- [ ] 启动成功，监听 8001 端口
- [ ] Swagger 文档可访问（/docs）
- [ ] GET /healthz 返回 `{"ok": true}`
- [ ] GET /v1/limits 返回正确限额
- [ ] POST /v1/chat/completions（stream=false）返回 Mock 消息
- [ ] 日志显示正确的模式和档位

### 前端（Web）

- [ ] 启动成功，可访问
- [ ] 页面不是空白
- [ ] 顶栏显示品牌、绿色状态灯、设置按钮
- [ ] 左侧栏显示会话列表和新建按钮
- [ ] 中央区域显示输入框和 Token 计数
- [ ] 输入框下方显示正确的模式和档位
- [ ] 可以发送消息
- [ ] AI 消息逐字显示（SSE 流式）
- [ ] 消息支持复制
- [ ] 停止按钮可用
- [ ] 设置抽屉正常打开
- [ ] 设置可以调整并保存
- [ ] 可以创建/切换/重命名会话
- [ ] 刷新页面后数据保持

### 模式切换

- [ ] 切换配置文件后网关正确加载
- [ ] 前端刷新后显示新的限额
- [ ] 单人模式：3072/512 tokens，无限流
- [ ] 多人模式：2048/256 tokens，有限流

---

## 🎉 验收成功标准

如果以上清单**全部打勾**，恭喜！系统运行完美！

---

## 📊 性能测试（可选）

### 压测工具

```powershell
# 新开终端
cd H:\project\cxygpt

# 安装依赖（如果未安装）
pip install httpx

# 运行压测（轻量级）
python scripts\bench.py --concurrency 5 --rounds 5

# 运行压测（标准）
python scripts\bench.py --concurrency 10 --rounds 10
```

**预期输出**：
```
开始压测:
  URL: http://127.0.0.1:8001/v1/chat/completions
  并发数: 10
  轮次: 10
  总请求数: 100

轮次 1/10...
...

============================================================
压测结果
============================================================

总请求数: 100
成功数: 100
失败数: 0

首 token 延迟:
  平均: 0.010s
  P95: 0.015s
...
```

---

## 🎯 下一步

### 验收通过后，你可以：

1. **接入真实 vLLM**
   - 准备模型文件
   - 修改 `.env` 设置 `USE_MOCK=0`
   - 启动 vLLM 服务
   - 测试真实对话

2. **探索高级功能**
   - 测试不同的系统提示模板
   - 调整温度、Top-P 参数
   - 创建多个会话并切换
   - 尝试长文本对话

3. **性能优化**
   - 运行压测获取基准数据
   - 根据结果调整 profiles.yaml
   - 测试多人模式的并发性能

4. **功能扩展**
   - 启动 Django 后台（后续）
   - 接入 RAG 功能（后续）
   - 部署到生产环境

---

## 📚 相关文档

- **快速验收脚本**：`verify.ps1`
- **详细启动指南**：`QUICKSTART.md`
- **项目总览**：`README.md`
- **前端文档**：`apps/web/README.md`
- **网关文档**：`apps/api-gateway/README.md`
- **档位配置**：`configs/profiles.yaml`

---

## 🆘 需要帮助？

如果遇到问题：

1. 查看本文档的"故障排查"部分
2. 检查浏览器开发者工具 Console
3. 查看网关终端日志
4. 确认所有文件都已创建

---

**文档版本**：v2.0 完整版
**最后更新**：2025-10-06
**验收时长**：约 15-20 分钟

**祝验收顺利！🎉**
